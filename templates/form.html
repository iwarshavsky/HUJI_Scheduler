<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hebrew University Schedule Planner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>
<body>

<h1>Hebrew University Schedule Planner</h1>
<div class="container">
    <!-- Left: Form Section -->
    <div class="form-section">
        <form onsubmit="return validateForm()" method="post" id="requestForm" action="/submit">
            <label for="year">Year:</label>
            <input type="number" id="year" name="year" min="1900" max="2100" value="2025">


            <label for="semester">Semester (A or B):</label>
            <input type="text" id="semester" name="semester" pattern="[AB]{1}" value="A">

            <label for="courseNumberInput">Course Number (up to 6 digits):</label>
            <div class="course-entry">
                <input type="text" id="courseNumberInput" maxlength="6" pattern="\d{1,6}" placeholder="Enter course number" value="8013">
                <button type="button" onclick="addCourse()">Add Course</button>
            </div>


            <!-- Hidden input for submission -->
            <input type="hidden" name="courses" id="coursesHidden">

            <!-- Display added courses -->
            <div id="courseList" style="margin-top: 10px;"></div>


            <label for="maxDayLength">Maximal Day Length:</label>
            <select id="maxDayLength" name="max_day_length"></select>

            <label for="minDayLength">Minimal Day Length:</label>
            <select id="minDayLength" name="min_day_length"></select>

            <label for="minFreeDays">Minimal Number of Free Days:</label>
            <input type="number" id="minFreeDays" name="min_free_days" min="0">

            <label for="globalStartTime">Global Start Time:</label>
            <select id="globalStartTime" name="globalStartTime"></select>

            <div class="grouped">
                <label for="dayWithBreakDayLength">Day With Break - Day Length:</label>
                <select id="dayWithBreakDayLength" name="dayWithBreak_DayLength"></select>

                <label for="dayWithBreakBreakLength">Day With Break - Break Length:</label>
                <select id="dayWithBreakBreakLength" name="dayWithBreak_BreakLength"></select>
            </div>
            <div id="errorsContainer"></div>
            <button type="submit">Submit</button>
        </form>
    </div>
    <!-- Right: Empty Div Section -->
    <div class="preview-section">
        <button id="getNextBtn_post">Get Next (POST)</button>
        <a href="/get/0">Download</a>
<!--        <button id="getNextBtn_get">Get Next (GET)</button>-->
        <!-- This space can be used for dynamic content -->
    </div>
</div>
<script>
    // Create time options from 00:00 to 16:00 in 15-min intervals
    function fillTimeOptions(selectId) {
        const select = document.getElementById(selectId);
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Select time";
        select.appendChild(placeholder);

        for (let hour = 0; hour <= 20; hour++) {
            for (let min = 0; min < 60; min += 15) {
                const h = hour.toString().padStart(2, '0');
                const m = min.toString().padStart(2, '0');
                const option = document.createElement("option");
                option.value = `${h}:${m}`;
                option.textContent = `${h}:${m}`;
                select.appendChild(option);
            }
        }
    }

    const timeFields = [
        "maxDayLength",
        "minDayLength",
        "globalStartTime",
        "dayWithBreakDayLength",
        "dayWithBreakBreakLength"
    ];
    timeFields.forEach(id => fillTimeOptions(id));

    function validateForm() {
        const dayLength = document.getElementById("dayWithBreakDayLength").value;
        const breakLength = document.getElementById("dayWithBreakBreakLength").value;
        const onlyOneFilled = (dayLength && !breakLength) || (!dayLength && breakLength);

        if (onlyOneFilled) {
            alert("Please fill in both Day Length and Break Length or leave both empty.");
            return false;
        }
        return true;
    }
</script>

<script>
    let addedCourses = [];


    function addCourse() {
        const courseNumberInput = document.getElementById("courseNumberInput");
        const yearInput = document.getElementById("year");
        const semesterInput = document.getElementById("semester");

        const courseNumber = courseNumberInput.value.trim();
        const year = yearInput.value.trim();
        const semester = semesterInput.value.trim();

        if (!courseNumber || isNaN(courseNumber) || courseNumber.length > 6) {
            alert("Please enter a valid course number (up to 6 digits).");
            return;
        }

        if (responseStore.has(courseNumber)) {
            alert("Course already added.");
            return;
        }

        sendGetRequest('/get_course', {"year": year, "semester": semester, "id": courseNumber})
            .then(data => {
                if (data) {
                    responseStore.add(courseNumber, data);
                    updateCourseList();
                } else {
                    throw Error("No data")
                }

            })
            .catch(error => {
                alert(error.message);
                console.error('Caught an error:', error.message); // â† Catches your thrown error here
            });

        courseNumberInput.value = "";


    }

    function removeCourse(courseNumber) {
        responseStore.delete(courseNumber);
        updateCourseList();
    }


    function updateCourseList() {
        const courseListDiv = document.getElementById("courseList");
        courseListDiv.innerHTML = "";

        Object.keys(responseStore.data).forEach(course => {
          console.log(`Key: ${course}`);
          console.log('Value:', responseStore[course]);
            const wrapper = document.createElement("div");
            wrapper.className = "course-item";

            const label = document.createElement("span");
            label.className = "course-text";

            const icon = document.createElement("span");
            icon.className = "course-icon";

            const number = document.createElement("a");
            number.textContent = course;
            number.onclick = () => openModal(responseStore.data[course]);

            label.appendChild(icon);
            label.appendChild(number);

            const removeBtn = document.createElement("button");
            removeBtn.textContent = "âŒ";
            removeBtn.onclick = () => removeCourse(course);

            wrapper.appendChild(label);
            wrapper.appendChild(removeBtn);
            courseListDiv.appendChild(wrapper);
        });
    }

    document.getElementById('requestForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const jsonData = Object.fromEntries(formData.entries());
        jsonData.courses = responseStore.data
        fetch('/submit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(jsonData)
        })
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('errorsContainer');
                container.innerHTML = ''; // Clear previous errors

                if (!data.success && data.errors) {
                    Object.entries(data.errors).forEach(([key, message]) => {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message'; // Add styles as needed
                        errorDiv.textContent = `${key}: ${message}`;
                        container.appendChild(errorDiv);
                    });
                }
            });
    });


    const responseStore = {
        data: {},

        add(key, jsonResponse) {
            this.data[key] = jsonResponse;

        },

        get(key) {
            return this.data[key];
        },

        delete(key) {
            if (key in this.data) {
                delete this.data[key];
                return true;  // indicates success
            }
            return false; // key not found
        },
          has(key) {
            return key in this.data;
          }
    };

    function sendGetRequest(url, params = {}, headers = {}) {
        const queryString = new URLSearchParams(params).toString();
        const fullUrl = queryString ? `${url}?${queryString}` : url;

        return fetch(fullUrl, {
            method: 'GET',
            headers: {'Accept': 'application/json', ...headers}
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error ${res.status}`);
                }
                return res.json();
            })

            .catch(error => {
                console.error('Fetch error:', error)
                // throw(error);
            });
    }

    // Example fetch + store




</script>
<script>
    document.getElementById('getNextBtn_post').addEventListener('click', function () {
        fetch('/get/0', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({request: 'next'})  // Optional payload
        })
            .then(res => res.json())
            .then(data => {
                console.log('Server response:', data);
                // You can update the DOM with the response here
            })
            .catch(err => console.error('Error:', err));
    });

    // document.getElementById('getNextBtn_get').addEventListener('click', function () {
    //     sendGetRequest("/get/0");
    // });


</script>


<div id="jsonModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>Edit pool_dict</h3>
        <div id="editorContainer"></div>
        <button onclick="deletePoolDict()">ðŸ—‘ Delete pool_dict</button>
    </div>
</div>

<script>
    let workingJson = null;

    function openModal(json) {
        workingJson = json; //= JSON.parse(JSON.stringify(json)); // Deep copy
        document.getElementById("jsonModal").style.display = "block";
        renderEditor();
    }

    function closeModal() {
        document.getElementById("jsonModal").style.display = "none";
        workingJson = null;
    }

    function renderEditor() {
        const container = document.getElementById("editorContainer");
        container.innerHTML = "";

        if (!workingJson?.pool_dict) {
            container.innerHTML = "<p><strong>pool_dict is missing or deleted.</strong></p>";
            return;
        }

        for (const [type, groups] of Object.entries(workingJson.pool_dict)) {
            const typeDiv = document.createElement("div");
            typeDiv.className = "lesson-type";
            typeDiv.innerHTML = `<strong>${type}</strong>`; //<button onclick="addGroup('${type}')">âž• Add Group</button>

            groups.forEach((group, gIndex) => {
                const groupDiv = document.createElement("div");
                groupDiv.className = "group";

                groupDiv.innerHTML = `
        <div>
          <strong>Group ${group.group}</strong>
          <button onclick="deleteGroup('${type}', ${gIndex})">ðŸ—‘</button>
          <button onclick="addEvent('${type}', ${gIndex})">âž• Add Event</button>
        </div>
      `;

                group.event_list.forEach((event, eIndex) => {
                    const eventDiv = document.createElement("div");
                    eventDiv.className = "event";

                    for (const [key, value] of Object.entries(event)) {
                        const input = document.createElement("input");
                        input.value = value;
                        input.dataset.type = type;
                        input.dataset.gIndex = gIndex;
                        input.dataset.eIndex = eIndex;
                        input.dataset.key = key;
                        input.oninput = handleEdit;
                        eventDiv.appendChild(input);
                    }

                    const delBtn = document.createElement("button");
                    delBtn.textContent = "âŒ";
                    delBtn.onclick = () => deleteEvent(type, gIndex, eIndex);
                    eventDiv.appendChild(delBtn);

                    groupDiv.appendChild(eventDiv);
                });

                typeDiv.appendChild(groupDiv);
            });

            container.appendChild(typeDiv);
        }
    }

    function handleEdit(e) {
        const {type, gIndex, eIndex, key} = e.target.dataset;
        let val = e.target.value;
        if (!isNaN(val)) val = Number(val);
        workingJson.pool_dict[type][gIndex].event_list[eIndex][key] = val;
    }

    function deleteEvent(type, gIndex, eIndex) {
        workingJson.pool_dict[type][gIndex].event_list.splice(eIndex, 1);
        renderEditor();
    }

    function deleteGroup(type, gIndex) {
        workingJson.pool_dict[type].splice(gIndex, 1);
        if (workingJson.pool_dict[type].length === 0) delete workingJson.pool_dict[type];
        renderEditor();
    }

    function deletePoolDict() {
        delete workingJson.pool_dict;
        closeModal();
    }

    function addEvent(type, gIndex) {
        const defaultEvent = {
            days: 0, time_start: 0, time_finish: 0,
            lesson: type, places: "", note: ""
        };
        workingJson.pool_dict[type][gIndex].event_list.push(defaultEvent);
        renderEditor();
    }

    function addGroup(type) {
        const defaultGroup = {
            course_num: workingJson.course || "",
            group: "?", semester: workingJson.semester || 0,
            lesson_type: type,
            event_list: []
        };
        workingJson.pool_dict[type].push(defaultGroup);
        renderEditor();
    }

    // Sample JSON to test
</script>


</body>
</html>

